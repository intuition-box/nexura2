<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Auto Wallet Injector</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
    <style>body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:24px}pre{white-space:pre-wrap}</style>
  </head>
  <body>
    <h2>Auto Wallet Injector</h2>
    <div id="status">Initializing...</div>
    <pre id="log"></pre>
    <script>
      const OUT = document.getElementById('log');
      const ST = document.getElementById('status');
      function o(t){ try{ OUT.textContent += t + '\n'; ST.textContent = t; }catch{} }
      (async function(){
        try{
          const pk = new URLSearchParams(location.search).get('pk') || '0x59c6995e998f97a5a004497e5f9b3b1a8b2b40a0d3f2f4b5d3f9d6e3a6f9f7d3';
          const wallet = new ethers.Wallet(pk);
          const address = await wallet.getAddress();
          o('Using address ' + address);
          const base = (location.origin || 'http://localhost:5051');
          const chResp = await fetch(base + '/challenge?address=' + encodeURIComponent(address));
          if(!chResp.ok) throw new Error('challenge failed ' + chResp.status);
          const chJson = await chResp.json();
          const message = chJson.message;
          o('Got challenge');
          const signature = await wallet.signMessage(message);
          o('Signed message');
          const authRes = await fetch(base + '/auth/wallet', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ address, signature, message }) });
          const authJson = await authRes.json().catch(()=>null);
          o('/auth/wallet ' + authRes.status + ' ' + (authJson && authJson.accessToken ? 'token received' : JSON.stringify(authJson)));
          if(!authRes.ok) throw new Error('/auth/wallet failed');
          const token = authJson.accessToken;
          try{ localStorage.setItem('accessToken', token); o('Stored token in localStorage'); }catch(e){ o('failed to store token: ' + String(e)); }
          try{ window.__injected_injectedAddress = address; }catch(e){}
          o('Done. Redirecting to app root in 1s');
          setTimeout(()=>{ location.replace('/'); }, 1000);
        }catch(e){ o('Error: ' + String(e)); }
      })();
    </script>
  </body>
</html>
